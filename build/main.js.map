{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["import 'reflect-metadata';\n\nimport * as utils from '@iobroker/adapter-core';\nimport { DependencyContainer } from 'tsyringe';\n\nimport { IConnectedServiceAdapter, IConnectedServiceContext } from '@acaad/abstractions/src';\n\nimport { FrameworkContainer, ComponentManager } from '@acaad/core';\n\nimport { IoBrokerContext } from './services/IoBroker.Context';\nimport { IoBrokerCsAdapter } from './services/IoBroker.ConnectedServiceAdapter';\n\nimport { Option, pipe } from 'effect';\n\nclass Acaad extends utils.Adapter {\n  private _fwkContainer: DependencyContainer;\n  private _componentManager: Option.Option<ComponentManager> = Option.none();\n\n  // Not using Option here for performance reasons.\n  private _context: IoBrokerContext | null = null;\n\n  public constructor(options: Partial<utils.AdapterOptions> = {}) {\n    super({\n      ...options,\n      name: 'acaad'\n    });\n    this.on('ready', this.onReady.bind(this));\n    this.on('stateChange', this.onStateChange.bind(this));\n\n    this.on('unload', this.onUnload.bind(this));\n\n    if (!this.config.targetServices) {\n      this.config.targetServices = [];\n    }\n\n    if (!this.config.auth) {\n      // TODO: Raise an error later.\n      // Here the logger is not yet available.\n      console.log('No auth provided.');\n    }\n\n    this._fwkContainer = this.createDiContainer();\n  }\n\n  private createDiContainer(): DependencyContainer {\n    const ioBrokerContext = new IoBrokerContext(this);\n    const contextToken = IoBrokerContext.Token;\n\n    return FrameworkContainer.CreateCsContainer<IConnectedServiceAdapter>({\n      useClass: IoBrokerCsAdapter\n    })\n      .WithContext<IConnectedServiceContext>(contextToken, ioBrokerContext)\n      .Build();\n  }\n\n  private async onReady(): Promise<void> {\n    const instance = this._fwkContainer.resolve(ComponentManager) as ComponentManager;\n    this._componentManager = Option.some(instance);\n\n    const componentCreation = await instance.createMissingComponentsAsync();\n\n    if (componentCreation) {\n      await instance.startAsync();\n    } else {\n      console.log('Failed to create components.');\n      // TODO: Stop the adapter\n    }\n  }\n\n  private async onUnload(callback: () => void): Promise<void> {\n    try {\n      // TODO: Add AbortController+Signal to limit shutdown duration, if necessary force-stop.\n      // Alternatively, fork (?) an effect and race it as timeout.\n\n      await pipe(\n        this._componentManager,\n        Option.match({\n          onSome: (cm) => cm.shutdownAsync(), // TODO: Add timeout\n          onNone: () => Promise.resolve()\n        })\n      );\n    } finally {\n      await this._fwkContainer.dispose();\n      callback();\n    }\n  }\n\n  private async onStateChange(id: string, state: ioBroker.State | null | undefined): Promise<void> {\n    await (this._context ??= this._fwkContainer.resolve(\n      IoBrokerContext.Token\n    ) as IoBrokerContext).onStateChangeAsync(id, state);\n  }\n}\n\nif (require.main !== module) {\n  module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new Acaad(options);\n} else {\n  (() => new Acaad())();\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;AAAA,8BAAO;AAEP,YAAuB;AAKvB,kBAAqD;AAErD,sBAAgC;AAChC,IAAAA,mBAAkC;AAElC,oBAA6B;AAE7B,MAAM,cAAc,MAAM,QAAQ;AAAA,EACxB;AAAA,EACA,oBAAqD,qBAAO,KAAK;AAAA;AAAA,EAGjE,WAAmC;AAAA,EAEpC,YAAY,UAAyC,CAAC,GAAG;AAC9D,UAAM;AAAA,MACJ,GAAG;AAAA,MACH,MAAM;AAAA,IACR,CAAC;AACD,SAAK,GAAG,SAAS,KAAK,QAAQ,KAAK,IAAI,CAAC;AACxC,SAAK,GAAG,eAAe,KAAK,cAAc,KAAK,IAAI,CAAC;AAEpD,SAAK,GAAG,UAAU,KAAK,SAAS,KAAK,IAAI,CAAC;AAE1C,QAAI,CAAC,KAAK,OAAO,gBAAgB;AAC/B,WAAK,OAAO,iBAAiB,CAAC;AAAA,IAChC;AAEA,QAAI,CAAC,KAAK,OAAO,MAAM;AAGrB,cAAQ,IAAI,mBAAmB;AAAA,IACjC;AAEA,SAAK,gBAAgB,KAAK,kBAAkB;AAAA,EAC9C;AAAA,EAEQ,oBAAyC;AAC/C,UAAM,kBAAkB,IAAI,gCAAgB,IAAI;AAChD,UAAM,eAAe,gCAAgB;AAErC,WAAO,+BAAmB,kBAA4C;AAAA,MACpE,UAAU;AAAA,IACZ,CAAC,EACE,YAAsC,cAAc,eAAe,EACnE,MAAM;AAAA,EACX;AAAA,EAEA,MAAc,UAAyB;AACrC,UAAM,WAAW,KAAK,cAAc,QAAQ,4BAAgB;AAC5D,SAAK,oBAAoB,qBAAO,KAAK,QAAQ;AAE7C,UAAM,oBAAoB,MAAM,SAAS,6BAA6B;AAEtE,QAAI,mBAAmB;AACrB,YAAM,SAAS,WAAW;AAAA,IAC5B,OAAO;AACL,cAAQ,IAAI,8BAA8B;AAAA,IAE5C;AAAA,EACF;AAAA,EAEA,MAAc,SAAS,UAAqC;AAC1D,QAAI;AAIF,gBAAM;AAAA,QACJ,KAAK;AAAA,QACL,qBAAO,MAAM;AAAA,UACX,QAAQ,CAAC,OAAO,GAAG,cAAc;AAAA;AAAA,UACjC,QAAQ,MAAM,QAAQ,QAAQ;AAAA,QAChC,CAAC;AAAA,MACH;AAAA,IACF,UAAE;AACA,YAAM,KAAK,cAAc,QAAQ;AACjC,eAAS;AAAA,IACX;AAAA,EACF;AAAA,EAEA,MAAc,cAAc,IAAY,OAAyD;AAvFnG;AAwFI,YAAO,UAAK,aAAL,iBAAK,WAAa,KAAK,cAAc;AAAA,MAC1C,gCAAgB;AAAA,IAClB,GAAsB,mBAAmB,IAAI,KAAK;AAAA,EACpD;AACF;AAEA,IAAI,QAAQ,SAAS,QAAQ;AAC3B,SAAO,UAAU,CAAC,YAAuD,IAAI,MAAM,OAAO;AAC5F,OAAO;AACL,GAAC,MAAM,IAAI,MAAM,GAAG;AACtB;",
  "names": ["import_IoBroker"]
}
