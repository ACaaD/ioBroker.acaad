{
  "version": 3,
  "sources": ["../../src/services/IoBroker.Context.ts"],
  "sourcesContent": ["import {\n  IConnectedServiceContext,\n  ICsLogger,\n  OutboundStateChangeCallback,\n  ChangeType,\n  AcaadAuthentication,\n  AcaadHost,\n  Component\n} from '@acaad/core';\n\nimport IoBrokerLogger from './IoBroker.Logger';\nimport { injectable } from 'tsyringe';\nimport { Option } from 'effect';\nimport { Actions } from './IoBroker.Constants';\nimport { isObject } from 'effect/Predicate';\nimport { isArray } from 'effect/Array';\n\n@injectable()\nexport class IoBrokerContext implements IConnectedServiceContext {\n  public static Token = 'di-IoBrokerContext';\n\n  public logger: ICsLogger;\n\n  private _adapter: ioBroker.Adapter;\n\n  private _componentState: Record<string, Component> = {};\n\n  private _outboundStateChangeCallback: OutboundStateChangeCallback | null = null;\n\n  constructor(adapter: ioBroker.Adapter) {\n    this.logger = new IoBrokerLogger(adapter);\n    this._adapter = adapter;\n  }\n\n  getConfiguredServers(): AcaadHost[] {\n    let target = this._adapter.config.targetServices;\n    const authFromCfg = this._adapter.config.auth;\n\n    /* Enable int-tests */\n    if (isObject(target) && !isArray(target)) {\n      target = Object.values(target);\n    }\n\n    if (!target) {\n      return [];\n    }\n\n    let auth: AcaadAuthentication | undefined;\n    if (authFromCfg) {\n      auth = new AcaadAuthentication(\n        authFromCfg.tokenUrl,\n        authFromCfg.clientId,\n        authFromCfg.clientSecret,\n        []\n      );\n    }\n\n    return target.map((t) => new AcaadHost(t.name, t.host, t.port, auth, t.signalrPort));\n  }\n\n  getNamespace(): string {\n    return this._adapter.namespace;\n  }\n\n  // TODO: Use preserver\n  async extendObjectAsync(\n    objectIdentifier: string,\n    partialObject: ioBroker.PartialObject\n  ): ioBroker.SetObjectPromise {\n    return await this._adapter.extendObject(objectIdentifier, partialObject, {\n      preserve: { common: ['name'] }\n    });\n  }\n\n  async registerStateChangeCallbackAsync(cb: OutboundStateChangeCallback): Promise<void> {\n    this.logger.logDebug('Received state change callback. Registering.');\n\n    // TODO: Mutex removed\n\n    try {\n      this._adapter.subscribeStates(`${this._adapter.namespace}.*`);\n      this._outboundStateChangeCallback = cb;\n    } finally {\n      // TODO: Mutex removed\n    }\n  }\n\n  async onStateChangeAsync(id: string, state: ioBroker.State | null | undefined): Promise<void> {\n    if (state?.ack === true) {\n      return;\n    }\n\n    const triggeredForComponent: Component | undefined | null = this._componentState[id];\n\n    if (!triggeredForComponent) {\n      this.logger.logWarning(`State change for unknown component with id ${id}`);\n      return;\n    }\n\n    if (!this._outboundStateChangeCallback) {\n      this.logger.logWarning(`State change for component ${triggeredForComponent.name} but no callback set.`);\n      return;\n    }\n\n    const changeType = this.getChangeType(id);\n\n    if (!changeType) {\n      this.logger.logDebug(\n        `Change type for state ${id} could not be determined. Assuming user-defined state or update and doing nothing.`\n      );\n      return;\n    }\n\n    // TODO IMPORTANT: Seems a state being deleted triggers the metadata action /lul.\n    const triggerVal: Option.Option<unknown> = this.isNullOrUndefined(state?.val)\n      ? Option.none()\n      : Option.some(state?.val);\n\n    const success = await this._outboundStateChangeCallback(triggeredForComponent, changeType, triggerVal);\n\n    if (success) {\n      await this.setStateAsync(id, { ack: true });\n    }\n  }\n\n  // TODO: Temporary\n  private isNullOrUndefined(val: unknown): boolean {\n    return val === null || val === undefined;\n  }\n\n  public async setStateAsync(id: string, val: ioBroker.SettableState): Promise<void> {\n    this.logger.logTrace(`Setting state ${id} to ${JSON.stringify(val)}`);\n\n    await this._adapter.setState(id, { ...val, ack: true });\n  }\n\n  // Hooray for nested ternaries!\n  // TODO: Use regex.. map from group 1..\n  private getChangeType(id: string): ChangeType | null {\n    return id.endsWith(`.${Actions.Sync}`)\n      ? 'query'\n      : id.endsWith(`.${Actions.Switch}`) || id.endsWith(`.${Actions.Trigger}`)\n        ? 'action'\n        : null;\n  }\n\n  async addObjectAsync(objectIdentifier: string, component: Component): Promise<void> {\n    // TODO: Mutex removed\n\n    try {\n      if (!this._componentState[objectIdentifier]) {\n        this._componentState[objectIdentifier] = component;\n        return;\n      }\n\n      throw new Error(\n        `Component with identifier ${objectIdentifier} already exists. This is invalid and might happen if components contain forbidden characters and are not unique anymore after stripping. Check the configuration on ACAAD side.`\n      );\n    } finally {\n      // TODO: Mutex removed\n    }\n  }\n\n  escapeComponentName(name: string): string {\n    return name.replaceAll(this._adapter.FORBIDDEN_CHARS, '');\n  }\n}\n"],
  "mappings": "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",
  "names": ["import_IoBroker", "IoBrokerLogger"]
}
